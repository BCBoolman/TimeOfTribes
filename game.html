<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time of Tribes - De Wereld</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { display: block; background: #000814; margin: 0; padding: 0; overflow: hidden; font-family: sans-serif; }
        #map { position: absolute; top: 0; left: 0; height: 100vh; width: 100vw; z-index: 2; }
        
        .leaflet-container {
            filter: grayscale(0.7) invert(0.9) hue-rotate(170deg) brightness(0.7) contrast(1.3);
            background: #000814 !important;
        }

        /* UI Styling */
        .game-ui-top { position: fixed; top: 0; left: 0; width: 100%; z-index: 100; display: flex; flex-direction: column; pointer-events: none; }
        .timer-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0, 0, 0, 0.9); border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px 15px; color: #e0e0e0; pointer-events: auto; }
        .timer-wrapper { display: flex; align-items: center; gap: 6px; font-variant-numeric: tabular-nums; min-width: 80px; }
        .resource-row { display: flex; justify-content: space-around; background: rgba(45, 45, 45, 0.95); padding: 8px 5px; color: #d1d1d1; font-size: 0.85rem; pointer-events: auto; }
        .logo-mini { height: 35px; }
        
        .game-ui-bottom { position: fixed; bottom: 25px; width: 100%; display: flex; justify-content: center; gap: 12px; z-index: 100; padding: 0 15px; }
        .game-btn { background: rgba(0, 0, 0, 0.75); border: 1px solid rgba(255, 255, 255, 0.2); color: #d1d1d1; padding: 12px 5px; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; flex: 1; max-width: 110px; text-align: center; pointer-events: auto; }
        
        /* Pop-up styling reset (omdat de kaart inverted is) */
        .leaflet-popup-content-wrapper { background: white; color: black; filter: none; }
    </style>
</head>
<body>

    <div class="game-ui-top">
        <div class="timer-row">
            <div class="timer-wrapper">‚òÄÔ∏è <span id="dayTimer">15:00</span></div>
            <img src="images/Time of Tribes - logo.svg" alt="Logo" class="logo-mini">
            <div class="timer-wrapper">‚è≥ <span id="playTimer">02:00:00</span></div>
        </div>
        <div class="resource-row">
            <div class="res-item">üåæ <span id="food">...</span></div>
            <div class="res-item">ü™µ <span id="wood">...</span></div>
            <div class="res-item">ü™® <span id="stone">...</span></div>
            <div class="res-item">üí∞ <span id="coins">...</span></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="game-ui-bottom">
        <button class="game-btn" onclick="locateUser()">GPS</button>
        <button class="game-btn" onclick="window.location.href='handel.html'">Handel</button>
        <button class="game-btn" id="interactBtn">Interactie</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbwwFXSrppzVf5aJc8TBm34WBgDyGug9yafNGdGB7shzGgcgtTrCZ8Q9RDp78Jlo2enx9Q/exec"; 
        
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.0907, 5.1214], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let userMarker;
        let locationLayer = L.layerGroup().addTo(map);

        const resourceIcons = {
            "voedsel": "üåæ",
            "hout": "ü™µ",
            "steen": "ü™®",
            "goud": "üí∞",
            "basis": "üè∞"
        };

        async function fetchResources() {
            const naam = localStorage.getItem("tribe_player");
            if (!naam) return;
            try {
                const response = await fetch(`${scriptURL}?action=getResources&naam=${encodeURIComponent(naam)}`);
                const data = await response.json();
                if (data.result === "success") {
                    document.getElementById('food').innerText = data.data.food;
                    document.getElementById('wood').innerText = data.data.wood;
                    document.getElementById('stone').innerText = data.data.stone;
                    document.getElementById('coins').innerText = data.data.coins;
                }
            } catch (e) { console.error("Resource error", e); }
        }

async function fetchLocations() {
    try {
        const response = await fetch(`${scriptURL}?action=getLocations&t=${new Date().getTime()}`);
        const json = await response.json();
        
        if (json.result === "success") {
            locationLayer.clearLayers();
            
            json.data.forEach(loc => {
                const coords = loc.coords.split(',').map(c => parseFloat(c.trim()));
                if (coords.length !== 2 || isNaN(coords[0])) return;

                // 1. Bepaal het icoon op basis van het type (kolom B)
                // We maken alles kleine letters en halen spaties weg voor de check
                const typeSchoon = loc.type.toLowerCase().trim();
                let emoji = "üìç"; // Standaard speld

                if (typeSchoon.includes("voedsel") || typeSchoon.includes("boerderij")) emoji = "üåæ";
                else if (typeSchoon.includes("hout")) emoji = "ü™µ";
                else if (typeSchoon.includes("steen")) emoji = "ü™®";
                else if (typeSchoon.includes("goud") || typeSchoon.includes("geld")) emoji = "üí∞";
                else if (typeSchoon.includes("basis") || typeSchoon.includes("kasteel")) emoji = "üè∞";

                // 2. Cirkel tekenen (Kleur uit kolom E van login tab via App Script)
                const circle = L.circle(coords, {
                    radius: 40,
                    color: loc.kleur,
                    fillColor: loc.kleur,
                    fillOpacity: 0.4,
                    weight: 2
                }).addTo(locationLayer);

                // 3. Icoon Marker maken
                const icon = L.divIcon({
                    html: `<div style="font-size: 24px; text-align: center; filter: drop-shadow(0 0 2px rgba(0,0,0,0.8));">${emoji}</div>`,
                    className: 'custom-icon',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15]
                });

                const marker = L.marker(coords, { icon: icon }).addTo(locationLayer);

                // 4. Pop-up koppelen
                const popupContent = `
                    <div style="min-width: 150px; color: #000;">
                        <h3 style="margin:0 0 5px 0; border-bottom: 1px solid #ccc;">${loc.omschrijving}</h3>
                        <table style="width: 100%; font-size: 0.9rem;">
                            <tr><td><b>Type:</b></td><td>${loc.type}</td></tr>
                            <tr><td><b>Eigenaar:</b></td><td>${loc.eigenaar || "Niemand"}</td></tr>
                            <tr><td><b>Status:</b></td><td>${loc.status}</td></tr>
                        </table>
                    </div>
                `;
                marker.bindPopup(popupContent);
                circle.bindPopup(popupContent);
            });
        }
    } catch (e) { 
        console.error("Fout bij ophalen locaties:", e); 
    }
}

        function locateUser() {
            map.locate({setView: true, maxZoom: 17});
        }

        map.on('locationfound', (e) => {
            if (userMarker) { userMarker.setLatLng(e.latlng); } 
            else { userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: "#ff0000", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map); }
        });

        function startTimers() {
            let daySeconds = 15 * 60;
            let playSeconds = 2 * 60 * 60;
            setInterval(() => {
                if (daySeconds > 0) daySeconds--; else daySeconds = 15 * 60;
                let m = Math.floor(daySeconds/60), s = daySeconds%60;
                document.getElementById('dayTimer').innerText = `${m}:${s<10?'0':''}${s}`;

                if (playSeconds > 0) playSeconds--;
                let ph = Math.floor(playSeconds/3600), pm = Math.floor((playSeconds%3600)/60), ps = playSeconds%60;
                document.getElementById('playTimer').innerText = `${ph}:${pm<10?'0':''}${pm}:${ps<10?'0':''}${ps}`;
            }, 1000);
        }

        window.onload = () => {
            if (!localStorage.getItem("tribe_player")) {
                window.location.href = "index.html";
            } else {
                startTimers();
                locateUser();
                fetchResources();
                fetchLocations();
                setInterval(fetchResources, 15000);
                setInterval(fetchLocations, 15000);
            }
        };
    </script>
</body>
</html>
