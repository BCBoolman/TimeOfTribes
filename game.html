<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time of Tribes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #000814; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        .leaflet-container { filter: grayscale(0.7) invert(0.9) hue-rotate(170deg) brightness(0.7) contrast(1.3); }

        .game-ui-top { position: fixed; top: 0; width: 100%; z-index: 100; pointer-events: none; }
        .timer-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.8); padding: 10px; color: white; pointer-events: auto; }
        .resource-row { display: flex; justify-content: space-around; background: rgba(40,40,40,0.9); padding: 8px; color: #ddd; font-size: 0.9rem; pointer-events: auto; }
        
        /* DE CRUCIALE FIX VOOR DE SPELDEN: */
        .custom-div-icon { 
            background: none !important; 
            border: none !important; 
            box-shadow: none !important;
        }

        .leaflet-popup-content-wrapper { background: white; color: black; filter: none; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="game-ui-top">
        <div class="timer-row">
            <div>‚òÄÔ∏è <span id="dayTimer">15:00</span></div>
            <div>‚è≥ <span id="playTimer">02:00:00</span></div>
        </div>
        <div class="resource-row">
            <div>üåæ <span id="food">...</span></div>
            <div>ü™µ <span id="wood">...</span></div>
            <div>ü™® <span id="stone">...</span></div>
            <div>üí∞ <span id="coins">...</span></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // VERVANG DEZE URL DOOR JE EIGEN EXEC URL
        const scriptURL = "https://script.google.com/macros/s/AKfycbxe-EZnCDree54JoIQ5bi-IxWVyhPWgcO-troQSBlu8tLVqX1frrQtYn5gAyfGl1GaT6A/exec"; 

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.0907, 5.1214], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        const locationLayer = L.layerGroup().addTo(map);

        function getEmoji(type) {
            const t = String(type).toLowerCase().trim();
            if (t.includes("voedsel")) return "üåæ";
            if (t.includes("hout")) return "ü™µ";
            if (t.includes("steen")) return "ü™®";
            if (t.includes("goud") || t.includes("munt") || t.includes("coins")) return "üí∞";
            if (t.includes("basis")) return "üè∞";
            return "üìç";
        }

        async function fetchGameData() {
            const naam = localStorage.getItem("tribe_player");
            if (!naam) return;

            // Grondstoffen updaten
            fetch(`${scriptURL}?action=getResources&naam=${encodeURIComponent(naam)}`)
                .then(r => r.json())
                .then(json => {
                    if(json.result === "success") {
                        document.getElementById('food').innerText = json.data.food;
                        document.getElementById('wood').innerText = json.data.wood;
                        document.getElementById('stone').innerText = json.data.stone;
                        document.getElementById('coins').innerText = json.data.coins;
                    }
                }).catch(e => console.error("Resource error"));

            // Locaties updaten
            fetch(`${scriptURL}?action=getLocations&t=${Date.now()}`)
                .then(r => r.json())
                .then(json => {
                    if(json.result === "success") {
                        locationLayer.clearLayers();
                        json.data.forEach(loc => {
                            if(!loc.coords) return;
                            const coords = loc.coords.split(',').map(c => parseFloat(c.trim()));
                            if(coords.length !== 2 || isNaN(coords[0])) return;

                            // 1. Teken Cirkel (gekleurd per team)
                            L.circle(coords, {
                                radius: 35,
                                color: loc.kleur,
                                fillColor: loc.kleur,
                                fillOpacity: 0.4,
                                weight: 3
                            }).addTo(locationLayer).bindPopup(`
                                <div style="color:black">
                                    <b>${loc.omschrijving}</b><br>
                                    Type: ${loc.type}<br>
                                    Eigenaar: ${loc.eigenaar || "Geen"}<br>
                                    Status: ${loc.status}
                                </div>
                            `);

                            // 2. Teken Emoji Marker (geforceerd zonder speld)
                            L.marker(coords, {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: `<div style="font-size:26px; text-align:center; filter: drop-shadow(0 0 2px black);">${getEmoji(loc.type)}</div>`,
                                    iconSize: [30, 30],
                                    iconAnchor: [15, 15]
                                })
                            }).addTo(locationLayer);
                        });
                    }
                }).catch(e => console.error("Location error"));
        }

        window.onload = () => {
            if (!localStorage.getItem("tribe_player")) {
                window.location.href = "index.html";
            } else {
                fetchGameData();
                setInterval(fetchGameData, 15000);
            }
        };
    </script>
</body>
</html>
