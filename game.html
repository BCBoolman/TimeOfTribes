<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time of Tribes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #000814; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        /* KAART FILTER: Maakt de kaart donker */
        .leaflet-container { 
            filter: grayscale(0.7) invert(0.9) hue-rotate(170deg) brightness(0.7) contrast(1.3); 
            background: #000814 !important; 
        }

        /* FIX VOOR ICONEN: Dit filter draait het kaart-filter terug voor de emoji's */
        /* Hierdoor krijgt goud weer een normale gele kleur */
        .custom-div-icon { 
            background: none !important; 
            border: none !important; 
            box-shadow: none !important; 
            pointer-events: none;
            filter: contrast(0.8) brightness(1.2) invert(1) hue-rotate(190deg); /* Tegen-filter */
        }

        /* POP-UP STYLING: Zorgt dat de tekst ook weer normale kleuren heeft */
        .leaflet-popup-content-wrapper { 
            background: #ffffff !important; 
            color: #000000 !important; 
            filter: invert(1) hue-rotate(190deg); /* Draait filter van de kaart terug voor leesbaarheid */
            border-radius: 8px;
            font-size: 14px;
        }

        /* UI ELEMENTEN */
        .game-ui-top { position: fixed; top: 0; width: 100%; z-index: 100; pointer-events: none; }
        .timer-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.9); padding: 10px 15px; color: white; pointer-events: auto; }
        .resource-row { display: flex; justify-content: space-around; background: rgba(45,45,45,0.9); padding: 8px; color: #ddd; font-size: 0.85rem; pointer-events: auto; }
        .game-ui-bottom { position: fixed; bottom: 25px; width: 100%; display: flex; justify-content: center; gap: 12px; z-index: 100; padding: 0 15px; box-sizing: border-box; }
        .game-btn { background: rgba(0, 0, 0, 0.75); border: 1px solid rgba(255, 255, 255, 0.2); color: #d1d1d1; padding: 12px 5px; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; flex: 1; max-width: 110px; text-align: center; pointer-events: auto; }
    </style>
</head>
<body>

    <div class="game-ui-top">
        <div class="timer-row">
            <div>‚òÄÔ∏è <span id="dayTimer">15:00</span></div>
            <div style="font-weight: bold;">VERKENNING</div>
            <div>‚è≥ <span id="playTimer">02:00:00</span></div>
        </div>
        <div class="resource-row">
            <div>üåæ <span id="food">0</span></div>
            <div>ü™µ <span id="wood">0</span></div>
            <div>ü™® <span id="stone">0</span></div>
            <div>üí∞ <span id="coins">0</span></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="game-ui-bottom">
        <button class="game-btn" onclick="locateUser()">GPS</button>
        <button class="game-btn" onclick="window.location.href='handel.html'">Handel</button>
        <button class="game-btn" id="interactBtn">Interactie</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbz6_tTDtYZAq0Ja5QSqjoO5p3WGEScaUW6MKcEdMtCt21xzeavL1SRLbJts7PRwOPbSMA/exec"; 

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.0907, 5.1214], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        const locationLayer = L.layerGroup().addTo(map);

        // Functie voor emoji selectie
        function getEmoji(omschrijving, type) {
            const tekst = (omschrijving + " " + type).toLowerCase();
            if (tekst.includes("voedsel") || tekst.includes("boerderij")) return "üåæ";
            if (tekst.includes("hout") || tekst.includes("bos")) return "ü™µ";
            if (tekst.includes("steen") || tekst.includes("mijn")) return "ü™®";
            if (tekst.includes("goud") || tekst.includes("munt") || tekst.includes("bank")) return "üí∞";
            if (tekst.includes("basis") || tekst.includes("kasteel")) return "üè∞";
            return "üìç";
        }

        // --- HOOFDFUNCTIE: KAART EN POP-UP UPDATEN ---
        async function updateGame() {
            const naam = localStorage.getItem("tribe_player");
            if (!naam) return;

            fetch(`${scriptURL}?action=getLocations&t=${Date.now()}`)
                .then(r => r.json()).then(json => {
                    if(json.result === "success") {
                        locationLayer.clearLayers();
                        json.data.forEach(loc => {
                            const coords = loc.coords.split(',').map(c => parseFloat(c.trim()));
                            if(coords.length !== 2 || isNaN(coords[0])) return;

                            // BLOK: POP-UP INHOUD (Kolom A, B, D en E)
                            const popupHTML = `
                                <div style="line-height: 1.4;">
                                    <strong style="font-size: 16px;">${loc.omschrijving}</strong><br>
                                    <span style="color: #666; font-style: italic;">${loc.type}</span><br>
                                    <hr style="border:0; border-top:1px solid #eee; margin: 8px 0;">
                                    <b>Status:</b> ${loc.status || "Geen bijzonderheden"}<br>
                                    <b>Team:</b> ${loc.eigenaar || "Neutraal"}
                                </div>
                            `;

                            // Teken de cirkel (gekleurd per team)
                            L.circle(coords, {
                                radius: 45,
                                color: loc.kleur,
                                fillColor: loc.kleur,
                                fillOpacity: 0.5,
                                weight: 3
                            }).addTo(locationLayer).bindPopup(popupHTML);

                            // Teken het icoon (Emoji)
                            L.marker(coords, {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: `<div style="font-size:28px; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${getEmoji(loc.omschrijving, loc.type)}</div>`,
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 16]
                                }),
                                interactive: false
                            }).addTo(locationLayer);
                        });
                    }
                });
            
            // Grondstoffen laden (Apart fetchje)
            fetch(`${scriptURL}?action=getResources&naam=${encodeURIComponent(naam)}`)
                .then(r => r.json()).then(json => {
                    if(json.result === "success") {
                        document.getElementById('food').innerText = json.data.food;
                        document.getElementById('wood').innerText = json.data.wood;
                        document.getElementById('stone').innerText = json.data.stone;
                        document.getElementById('coins').innerText = json.data.coins;
                    }
                });
        }

        function locateUser() {
            map.locate({setView: true, maxZoom: 17});
        }

        window.onload = () => {
            updateGame();
            setInterval(updateGame, 20000); 
        };
    </script>
</body>
</html>
