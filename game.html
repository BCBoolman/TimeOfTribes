<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time of Tribes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #000814; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        .leaflet-container { filter: grayscale(0.7) invert(0.9) hue-rotate(170deg) brightness(0.7) contrast(1.3); background: #000814 !important; }

        /* UI TOP */
        .game-ui-top { position: fixed; top: 0; width: 100%; z-index: 100; pointer-events: none; }
        .timer-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); padding: 10px 15px; color: white; pointer-events: auto; }
        .resource-row { display: flex; justify-content: space-around; background: rgba(45,45,45,0.9); padding: 8px; color: #ddd; font-size: 0.85rem; pointer-events: auto; }
        
        /* UI BOTTOM (Knoppen) */
        .game-ui-bottom { position: fixed; bottom: 25px; width: 100%; display: flex; justify-content: center; gap: 12px; z-index: 100; padding: 0 15px; box-sizing: border-box; }
        .game-btn { background: rgba(0, 0, 0, 0.75); border: 1px solid rgba(255, 255, 255, 0.2); color: #d1d1d1; padding: 12px 5px; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; flex: 1; max-width: 110px; text-align: center; backdrop-filter: blur(8px); }

        /* ICON STYLING */
        .custom-div-icon { background: none !important; border: none !important; box-shadow: none !important; }
        .leaflet-popup-content-wrapper { background: white; color: black; filter: none; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="game-ui-top">
        <div class="timer-row">
            <div>‚òÄÔ∏è <span id="dayTimer">15:00</span></div>
            <div style="font-weight: bold; letter-spacing: 1px;">Wereldkaart</div>
            <div>‚è≥ <span id="playTimer">02:00:00</span></div>
        </div>
        <div class="resource-row">
            <div>üåæ <span id="food">0</span></div>
            <div>ü™µ <span id="wood">0</span></div>
            <div>ü™® <span id="stone">0</span></div>
            <div>üí∞ <span id="coins">0</span></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="game-ui-bottom">
        <button class="game-btn" onclick="locateUser()">GPS</button>
        <button class="game-btn" onclick="window.location.href='handel.html'">Handel</button>
        <button class="game-btn" id="interactBtn">Interactie</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbycKROIrJ75sWO13x35j8FO1qFzpuiQ20JzHgQnO2TX4yDH7Qkuxbho5aJSEh2GZR8nWg/exec"; // VERVANG DEZE!

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.0907, 5.1214], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        const locationLayer = L.layerGroup().addTo(map);
        let userMarker;

        function getEmoji(type) {
            const t = String(type).toLowerCase().trim();
            if (t.includes("voedsel")) return "üåæ";
            if (t.includes("hout")) return "ü™µ";
            if (t.includes("steen")) return "ü™®";
            if (t.includes("goud") || t.includes("munt")) return "üí∞";
            if (t.includes("basis")) return "üè∞";
            return "üìç";
        }

        async function updateGame() {
            const naam = localStorage.getItem("tribe_player");
            if (!naam) return;

            // Grondstoffen
            fetch(`${scriptURL}?action=getResources&naam=${encodeURIComponent(naam)}`)
                .then(r => r.json()).then(json => {
                    if(json.result === "success") {
                        document.getElementById('food').innerText = json.data.food;
                        document.getElementById('wood').innerText = json.data.wood;
                        document.getElementById('stone').innerText = json.data.stone;
                        document.getElementById('coins').innerText = json.data.coins;
                    }
                }).catch(() => {});

            // Locaties
            fetch(`${scriptURL}?action=getLocations&t=${Date.now()}`)
                .then(r => r.json()).then(json => {
                    if(json.result === "success") {
                        locationLayer.clearLayers();
                        json.data.forEach(loc => {
                            const coords = loc.coords.split(',').map(Number);
                            if(coords.length !== 2) return;

                            L.circle(coords, {
                                radius: 35, color: loc.kleur, fillColor: loc.kleur, fillOpacity: 0.4, weight: 3
                            }).addTo(locationLayer).bindPopup(`<b>${loc.omschrijving}</b><br>Eigenaar: ${loc.eigenaar || "Geen"}<br>Status: ${loc.status}`);

                            L.marker(coords, {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: `<div style="font-size:26px; text-shadow: 2px 2px #000;">${getEmoji(loc.type)}</div>`,
                                    iconSize: [30, 30], iconAnchor: [15, 15]
                                })
                            }).addTo(locationLayer);
                        });
                    }
                }).catch(() => {});
        }

        function locateUser() {
            map.locate({setView: true, maxZoom: 17});
        }

        map.on('locationfound', (e) => {
            if (userMarker) { userMarker.setLatLng(e.latlng); } 
            else { userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: "#ff0000", color: "#fff", weight: 2, fillOpacity: 1 }).addTo(map); }
        });

        function startTimers() {
            let daySeconds = 15 * 60;
            let playSeconds = 2 * 60 * 60;
            setInterval(() => {
                if (daySeconds > 0) daySeconds--; else daySeconds = 15 * 60;
                let m = Math.floor(daySeconds/60), s = daySeconds%60;
                document.getElementById('dayTimer').innerText = `${m}:${s<10?'0':''}${s}`;
                if (playSeconds > 0) playSeconds--;
                let ph = Math.floor(playSeconds/3600), pm = Math.floor((playSeconds%3600)/60), ps = playSeconds%60;
                document.getElementById('playTimer').innerText = `${ph}:${pm<10?'0':''}${pm}:${ps<10?'0':''}${ps}`;
            }, 1000);
        }

        window.onload = () => {
            if (!localStorage.getItem("tribe_player")) {
                window.location.href = "index.html";
            } else {
                startTimers();
                locateUser();
                updateGame();
                setInterval(updateGame, 15000);
            }
        };
    </script>
</body>
</html>
