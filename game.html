<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time of Tribes</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* --- BASIS STYLING --- */
        body { margin: 0; padding: 0; background: #000814; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        .leaflet-container { filter: grayscale(0.7) invert(0.9) hue-rotate(170deg) brightness(0.7) contrast(1.3); background: #000814 !important; }

        /* --- UI FEEDBACK & ANIMATIE --- */
        .game-ui-bottom { position: fixed; bottom: 25px; width: 100%; display: flex; justify-content: center; gap: 12px; z-index: 100; padding: 0 15px; box-sizing: border-box; }
        
        .game-btn { 
            background: rgba(0, 0, 0, 0.75); 
            border: 1px solid rgba(255, 255, 255, 0.2); 
            color: #d1d1d1; 
            padding: 12px 5px; 
            font-size: 0.7rem; 
            text-transform: uppercase; 
            cursor: pointer; 
            flex: 1; 
            max-width: 110px; 
            text-align: center; 
            pointer-events: auto;
            transition: all 0.1s ease; /* Feedback animatie */
        }

        /* Feedback bij indrukken knop */
        .game-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
            color: #ffffff;
            border-color: #ffffff;
        }

        /* --- KAART ELEMENTEN FILTERS --- */
        /* Draait het donkere filter terug voor emoji's en popups */
        .custom-div-icon, .leaflet-popup-content-wrapper { 
            filter: invert(1) hue-rotate(190deg) brightness(1.1); 
        }
        .custom-div-icon { background: none !important; border: none !important; pointer-events: none; }
        .leaflet-popup-content-wrapper { background: white; color: black; border-radius: 8px; font-size: 14px; }

        /* --- GPS SPELD STYLING --- */
        .gps-marker {
            filter: none !important; /* GPS marker mag NIET ge√Ønverteerd worden */
        }

        .game-ui-top { position: fixed; top: 0; width: 100%; z-index: 100; pointer-events: none; }
        .timer-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.9); padding: 10px 15px; color: white; pointer-events: auto; }
        .resource-row { display: flex; justify-content: space-around; background: rgba(45,45,45,0.9); padding: 8px; color: #ddd; font-size: 0.85rem; pointer-events: auto; }
    </style>
</head>
<body>

    <div class="game-ui-top">
        <div class="timer-row">
            <div>‚òÄÔ∏è <span id="dayTimer">15:00</span></div>
            <div style="font-weight: bold;">VERKENNING</div>
            <div>‚è≥ <span id="playTimer">02:00:00</span></div>
        </div>
        <div class="resource-row">
            <div>üåæ <span id="food">0</span></div>
            <div>ü™µ <span id="wood">0</span></div>
            <div>ü™® <span id="stone">0</span></div>
            <div>üí∞ <span id="coins">0</span></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="game-ui-bottom">
        <button class="game-btn" onclick="locateUser()">GPS</button>
        <button class="game-btn" onclick="window.location.href='handel.html'">Handel</button>
        <button class="game-btn" onclick="alert('Interactie geactiveerd!')">Interactie</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbz6_tTDtYZAq0Ja5QSqjoO5p3WGEScaUW6MKcEdMtCt21xzeavL1SRLbJts7PRwOPbSMA/exec"; 

        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.0907, 5.1214], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        const locationLayer = L.layerGroup().addTo(map);
        let userMarker; // De GPS-speld van de speler

        /**
         * FUNCTIE: Selecteert emoji op basis van kolom A en B.
         */
        function getEmoji(omschrijving, type) {
            const tekst = (omschrijving + " " + type).toLowerCase();
            if (tekst.includes("voedsel") || tekst.includes("boerderij")) return "üåæ";
            if (tekst.includes("hout") || tekst.includes("bos")) return "ü™µ";
            if (tekst.includes("steen") || tekst.includes("mijn")) return "ü™®";
            if (tekst.includes("goud") || tekst.includes("munt")) return "üí∞";
            if (tekst.includes("basis") || tekst.includes("kasteel")) return "üè∞";
            return "üìç";
        }

        /**
         * FUNCTIE: Kaart verversen en data ophalen.
         */
        async function updateGame() {
            const naam = localStorage.getItem("tribe_player");
            if (!naam) return;

            fetch(`${scriptURL}?action=getLocations&t=${Date.now()}`)
                .then(r => r.json()).then(json => {
                    if(json.result === "success") {
                        locationLayer.clearLayers();
                        json.data.forEach(loc => {
                            const coords = loc.coords.split(',').map(c => parseFloat(c.trim()));
                            if(coords.length !== 2 || isNaN(coords[0])) return;

                            const popupHTML = `
                                <strong>${loc.omschrijving}</strong><br>
                                <small>${loc.type}</small><hr>
                                <b>Status:</b> ${loc.status}<br>
                                <b>Team:</b> ${loc.eigenaar}
                            `;

                            // Cirkel tekenen
                            L.circle(coords, {
                                radius: 45, color: loc.kleur, fillColor: loc.kleur, fillOpacity: 0.5, weight: 3
                            }).addTo(locationLayer).bindPopup(popupHTML);

                            // Icoon tekenen
                            L.marker(coords, {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: `<div style="font-size:28px;">${getEmoji(loc.omschrijving, loc.type)}</div>`,
                                    iconSize: [32, 32], iconAnchor: [16, 16]
                                }),
                                interactive: false
                            }).addTo(locationLayer);
                        });
                    }
                });

            // Grondstoffen balk verversen
            fetch(`${scriptURL}?action=getResources&naam=${encodeURIComponent(naam)}`)
                .then(r => r.json()).then(json => {
                    if(json.result === "success") {
                        document.getElementById('food').innerText = json.data.food;
                        document.getElementById('wood').innerText = json.data.wood;
                        document.getElementById('stone').innerText = json.data.stone;
                        document.getElementById('coins').innerText = json.data.coins;
                    }
                });
        }

        /**
         * FUNCTIE: GPS van speler vinden en marker tekenen/updaten.
         */
        function locateUser() {
            map.locate({setView: true, maxZoom: 17});
        }

        map.on('locationfound', (e) => {
            // Als de marker nog niet bestaat, maak hem aan met een felle blauwe kleur
            if (!userMarker) {
                userMarker = L.circleMarker(e.latlng, {
                    radius: 10,
                    fillColor: "#007bff", // Fel blauw
                    color: "white",
                    weight: 3,
                    fillOpacity: 1,
                    className: 'gps-marker' // Zodat het filter niet werkt
                }).addTo(map);
                userMarker.bindPopup("Jouw Locatie").openPopup();
            } else {
                userMarker.setLatLng(e.latlng); // Verplaats de bestaande marker
            }
        });

        window.onload = () => {
            updateGame();
            setInterval(updateGame, 20000); 
            locateUser(); // Zoek speler direct bij start
        };
    </script>
</body>
</html>
