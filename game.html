<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time of Tribes - De Wereld</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="style.css">
    
    <style>
        body { 
            display: block; 
            background: #000814; 
            margin: 0;
            padding: 0;
            overflow: hidden;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        #map { 
            position: absolute;
            top: 0; left: 0;
            height: 100vh; 
            width: 100vw; 
            z-index: 2;
        }

        .leaflet-container {
            filter: grayscale(0.7) invert(0.9) hue-rotate(170deg) brightness(0.7) contrast(1.3);
            background: #000814 !important;
        }

        .game-ui-top {
            position: fixed;
            top: 0; 
            left: 0;
            width: 100%;
            z-index: 100;
            display: flex;
            flex-direction: column;
            pointer-events: none;
        }

        .timer-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            color: #e0e0e0;
            pointer-events: auto;
            height: 60px;
        }

        .resource-row {
            display: flex;
            justify-content: space-around;
            align-items: center;
            background: rgba(45, 45, 45, 0.95);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            padding: 8px 5px;
            color: #d1d1d1;
            font-size: 0.85rem;
            letter-spacing: 1px;
            pointer-events: auto;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
        }

        .logo-mini {
            height: 35px;
            filter: drop-shadow(0 0 5px rgba(255, 255, 255, 0.2));
        }

        .res-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .game-ui-bottom {
            position: fixed;
            bottom: 25px;
            width: 100%;
            display: flex;
            justify-content: center;
            gap: 12px;
            z-index: 100;
            padding: 0 15px;
        }

        .game-btn {
            background: rgba(0, 0, 0, 0.75);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #d1d1d1;
            padding: 12px 5px;
            font-size: 0.7rem;
            letter-spacing: 2px;
            text-transform: uppercase;
            cursor: pointer;
            backdrop-filter: blur(8px);
            transition: all 0.3s ease;
            flex: 1;
            max-width: 110px;
            text-align: center;
        }

        .game-btn:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(0.95);
        }

        .leaflet-control-attribution { display: none; }
    </style>
</head>
<body>

    <div class="game-ui-top">
        <div class="timer-row">
            <div id="dayTimer">15:00</div>
            <img src="images/Time of Tribes - logo.svg" alt="Logo" class="logo-mini">
            <div id="playTimer">02:00:00</div>
        </div>
        
        <div class="resource-row">
            <div class="res-item">ðŸŒ¾ <span id="food">...</span></div>
            <div class="res-item">ðŸªµ <span id="wood">...</span></div>
            <div class="res-item">ðŸª¨ <span id="stone">...</span></div>
            <div class="res-item">ðŸ’° <span id="coins">...</span></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="game-ui-bottom">
        <button class="game-btn" onclick="locateUser()">GPS</button>
        <button class="game-btn" onclick="window.location.href='handel.html'">Handel</button>
        <button class="game-btn" id="interactBtn">Interactie</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIGURATIE ---
        // LET OP: Gebruik hier de URL van je NIEUWE implementatie
        const scriptURL = "https://script.google.com/macros/s/AKfycbx5DMeIcF3lzi9KP6sQy8crVJLHfWT9fbxk4AhSErHBYCtjepJqCdxanh93tCok8IhY8g/exec"; 

        // Initialisatie Kaart
        const map = L.map('map', {
            zoomControl: false,
            attributionControl: false,
            tap: false
        }).setView([52.0907, 5.1214], 15);
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

        let userMarker;

        // Functie: Grondstoffen Ophalen
        async function fetchResources() {
            const naam = localStorage.getItem("tribe_player");
            if (!naam) {
                console.warn("Geen speler gevonden in localStorage.");
                return;
            }

            try {
                // Toevoegen van een timestamp voorkomt dat de browser een oude versie uit het geheugen (cache) laadt
                const finalURL = `${scriptURL}?action=getResources&naam=${encodeURIComponent(naam)}&t=${new Date().getTime()}`;
                
                const response = await fetch(finalURL, {
                    method: "GET",
                    redirect: "follow" // Belangrijk voor Google Scripts
                });

                if (!response.ok) throw new Error('Netwerk verbinding mislukt');

                const data = await response.json();

                if (data.result === "success") {
                    document.getElementById('food').innerText = data.data.food;
                    document.getElementById('wood').innerText = data.data.wood;
                    document.getElementById('stone').innerText = data.data.stone;
                    document.getElementById('coins').innerText = data.data.coins;
                } else {
                    console.error("Server fout:", data.msg);
                }
            } catch (error) {
                console.error("Fout bij ophalen grondstoffen:", error);
            }
        }

        // GPS Functie
        function locateUser() {
            map.locate({setView: true, maxZoom: 17});
        }

        map.on('locationfound', (e) => {
            const playerStyle = {
                radius: 10,
                fillColor: "#8B0000",
                color: "#ff0000",
                weight: 2,
                opacity: 1,
                fillOpacity: 0.9
            };

            if (userMarker) {
                userMarker.setLatLng(e.latlng);
            } else {
                userMarker = L.circleMarker(e.latlng, playerStyle).addTo(map);
            }
        });

        map.on('locationerror', () => {
            console.warn("GPS kon niet worden gevonden.");
        });

        // Timer Systeem
        function startTimers() {
            let daySeconds = 15 * 60;
            let playSeconds = 2 * 60 * 60;

            const dayEl = document.getElementById('dayTimer');
            const playEl = document.getElementById('playTimer');

            setInterval(() => {
                if (daySeconds > 0) {
                    daySeconds--;
                    let m = Math.floor(daySeconds / 60);
                    let s = daySeconds % 60;
                    dayEl.innerText = `${m}:${s < 10 ? '0' : ''}${s}`;
                } else {
                    daySeconds = 15 * 60;
                }

                if (playSeconds > 0) {
                    playSeconds--;
                    let h = Math.floor(playSeconds / 3600);
                    let m = Math.floor((playSeconds % 3600) / 60);
                    let s = playSeconds % 60;
                    playEl.innerText = `${h}:${m < 10 ? '0' : ''}${m}:${s < 10 ? '0' : ''}${s}`;
                }
            }, 1000);
        }

        // Check login en start
        window.onload = () => {
            const player = localStorage.getItem("tribe_player");
            if (!player) {
                // Als er geen player is opgeslagen, stuur terug naar login
                window.location.href = "index.html";
            } else {
                startTimers();
                locateUser();
                fetchResources(); // Direct laden
                
                // Elke 30 seconden de teamvoorraad verversen
                setInterval(fetchResources, 15000);
            }
        };
    </script>
</body>
</html>
