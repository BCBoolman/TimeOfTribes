<!DOCTYPE html>
<html lang="nl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Time of Tribes - Kaart</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        /* BASIS LAYOUT: De kaart vult het hele scherm */
        body { margin: 0; padding: 0; background: #000814; font-family: sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        /* KAART FILTER: Maakt de kaart donker/futuristisch */
        .leaflet-container { 
            filter: grayscale(0.7) invert(0.9) hue-rotate(170deg) brightness(0.7) contrast(1.3); 
            background: #000814 !important; 
        }

        /* UI TOP: Balk met timers en grondstoffen */
        .game-ui-top { position: fixed; top: 0; width: 100%; z-index: 100; pointer-events: none; }
        .timer-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.9); padding: 10px 15px; color: white; pointer-events: auto; }
        .resource-row { display: flex; justify-content: space-around; background: rgba(45,45,45,0.9); padding: 8px; color: #ddd; font-size: 0.85rem; pointer-events: auto; }
        
        /* UI BOTTOM: Knoppen voor GPS en Handel */
        .game-ui-bottom { position: fixed; bottom: 25px; width: 100%; display: flex; justify-content: center; gap: 12px; z-index: 100; padding: 0 15px; box-sizing: border-box; }
        .game-btn { background: rgba(0, 0, 0, 0.75); border: 1px solid rgba(255, 255, 255, 0.2); color: #d1d1d1; padding: 12px 5px; font-size: 0.7rem; text-transform: uppercase; cursor: pointer; flex: 1; max-width: 110px; text-align: center; pointer-events: auto; }

        /* ICON STYLING: Zorgt dat emoji's geen blauwe speld achtergrond hebben */
        .custom-div-icon { background: none !important; border: none !important; box-shadow: none !important; pointer-events: none; }
        .leaflet-popup-content-wrapper { background: white; color: black; filter: none; border-radius: 8px; }
    </style>
</head>
<body>

    <div class="game-ui-top">
        <div class="timer-row">
            <div>‚òÄÔ∏è <span id="dayTimer">15:00</span></div>
            <div style="font-weight: bold;">VERKENNING</div>
            <div>‚è≥ <span id="playTimer">02:00:00</span></div>
        </div>
        <div class="resource-row">
            <div>üåæ <span id="food">0</span></div>
            <div>ü™µ <span id="wood">0</span></div>
            <div>ü™® <span id="stone">0</span></div>
            <div>üí∞ <span id="coins">0</span></div>
        </div>
    </div>

    <div id="map"></div>

    <div class="game-ui-bottom">
        <button class="game-btn" onclick="locateUser()">GPS</button>
        <button class="game-btn" onclick="window.location.href='handel.html'">Handel</button>
        <button class="game-btn" id="interactBtn">Interactie</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // --- CONFIGURATIE ---
        const scriptURL = "https://script.google.com/macros/s/AKfycbzk2v2NkyKoiKpKt1L5DeJ6D2nX_pSnvGkwk892a85Tzu6g-UnVQYP5A0FtdNUd4E0j/exec"; 

        // Initialiseer de kaart
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([52.0907, 5.1214], 15);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        
        const locationLayer = L.layerGroup().addTo(map);
        let userMarker;

        /**
         * FUNCTIE: Bepaalt de emoji op basis van de tekst in Kolom A of B.
         */
        function getEmoji(omschrijving, type) {
            const tekst = (omschrijving + " " + type).toLowerCase();
            if (tekst.includes("voedsel") || tekst.includes("boerderij")) return "üåæ";
            if (tekst.includes("hout") || tekst.includes("bos")) return "ü™µ";
            if (tekst.includes("steen") || tekst.includes("mijn")) return "ü™®";
            if (tekst.includes("goud") || tekst.includes("munt") || tekst.includes("bank")) return "üí∞";
            if (tekst.includes("basis") || tekst.includes("kasteel")) return "üè∞";
            return "üìç";
        }

        /**
         * FUNCTIE: Haalt alle data op uit de Google Sheet en tekent de kaart opnieuw.
         */
        async function updateGame() {
            const naam = localStorage.getItem("tribe_player");
            if (!naam) return;

            // 1. Grondstoffen bijwerken
            fetch(`${scriptURL}?action=getResources&naam=${encodeURIComponent(naam)}`)
                .then(r => r.json()).then(json => {
                    if(json.result === "success") {
                        document.getElementById('food').innerText = json.data.food;
                        document.getElementById('wood').innerText = json.data.wood;
                        document.getElementById('stone').innerText = json.data.stone;
                        document.getElementById('coins').innerText = json.data.coins;
                    }
                });

            // 2. Locaties en Iconen bijwerken
            fetch(`${scriptURL}?action=getLocations&t=${Date.now()}`)
                .then(r => r.json()).then(json => {
                    if(json.result === "success") {
                        locationLayer.clearLayers();
                        json.data.forEach(loc => {
                            const coords = loc.coords.split(',').map(c => parseFloat(c.trim()));
                            if(coords.length !== 2 || isNaN(coords[0])) return;

                            // Teken de cirkel (Dit is het klikbare gedeelte)
                            L.circle(coords, {
                                radius: 45,
                                color: loc.kleur,
                                fillColor: loc.kleur,
                                fillOpacity: 0.5,
                                weight: 3
                            }).addTo(locationLayer).bindPopup(`
                                <div style="color:black;">
                                    <b>${loc.omschrijving}</b><br>
                                    Eigenaar: ${loc.eigenaar || "Niemand"}
                                </div>
                            `);

                            // Plaats de Emoji (Zonder eigen klik-event, klik gaat door naar cirkel)
                            L.marker(coords, {
                                icon: L.divIcon({
                                    className: 'custom-div-icon',
                                    html: `<div style="font-size:28px; text-shadow: 2px 2px #000;">${getEmoji(loc.omschrijving, loc.type)}</div>`,
                                    iconSize: [32, 32],
                                    iconAnchor: [16, 16]
                                }),
                                interactive: false
                            }).addTo(locationLayer);
                        });
                    }
                });
        }

        /**
         * FUNCTIE: GPS Locatie van de speler vinden.
         */
        function locateUser() {
            map.locate({setView: true, maxZoom: 17});
        }

        map.on('locationfound', (e) => {
            if (userMarker) { userMarker.setLatLng(e.latlng); } 
            else { userMarker = L.circleMarker(e.latlng, { radius: 8, fillColor: "red", color: "white", weight: 2, fillOpacity: 1 }).addTo(map); }
        });

        // Start het spel en de timers
        window.onload = () => {
            updateGame();
            setInterval(updateGame, 20000); // Elke 20 seconden verversen
        };
    </script>
</body>
</html>
